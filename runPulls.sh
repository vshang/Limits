#!/bin/bash  

dir=$1
name=$(basename $2 .txt)
mass=$(echo $name | tr -dc '0-9')

ulimit -s unlimited

# text2workspace.py  $dir/$name.txt $dir/$name.root channel-masks

### Fitting ###
combine -M FitDiagnostics --datacard $dir/$name.root --expectSignal=0 --saveNormalizations --saveShapes --saveWithUncertainties --saveNLL  -n _$name -m $mass --setParameters mask_run16_SL1l0fT1SRbin_250_290=1,mask_run16_SL1l0fT1SRbin_290_330=1,mask_run16_SL1l0fT1SRbin_330_370=1,mask_run16_SL1l0fT1SRbin_370_410=1,mask_run16_SL1l0fT1SRbin_410_450=1,mask_run16_SL1l0fT1SRbin_450_490=1,mask_run16_SL1l0fT1SRbin_490_530=1,mask_run16_SL1l0fT2SRbin_250_290=1,mask_run16_SL1l0fT2SRbin_290_330=1,mask_run16_SL1l0fT2SRbin_330_370=1,mask_run16_SL1l0fT2SRbin_370_410=1,mask_run16_SL1l0fT2SRbin_410_450=1,mask_run16_SL1l0fT2SRbin_450_490=1,mask_run16_SL1l0fT2SRbin_490_530=1,mask_run16_SL1l0fT3SRbin_250_290=1,mask_run16_SL1l0fT3SRbin_290_330=1,mask_run16_SL1l0fT3SRbin_330_370=1,mask_run16_SL1l0fT3SRbin_370_410=1,mask_run16_SL1l0fT3SRbin_410_450=1,mask_run16_SL1l0fT3SRbin_450_490=1,mask_run16_SL1l0fT3SRbin_490_530=1,mask_run16_SL1l1fT1SRbin_250_290=1,mask_run16_SL1l1fT1SRbin_290_330=1,mask_run16_SL1l1fT1SRbin_330_370=1,mask_run16_SL1l1fT1SRbin_370_410=1,mask_run16_SL1l1fT1SRbin_410_450=1,mask_run16_SL1l1fT1SRbin_450_490=1,mask_run16_SL1l1fT1SRbin_490_530=1,mask_run16_SL1l1fT2SRbin_250_290=1,mask_run16_SL1l1fT2SRbin_290_330=1,mask_run16_SL1l1fT2SRbin_330_370=1,mask_run16_SL1l1fT2SRbin_370_410=1,mask_run16_SL1l1fT2SRbin_410_450=1,mask_run16_SL1l1fT2SRbin_450_490=1,mask_run16_SL1l1fT2SRbin_490_530=1,mask_run16_SL1l1fT3SRbin_250_290=1,mask_run16_SL1l1fT3SRbin_290_330=1,mask_run16_SL1l1fT3SRbin_330_370=1,mask_run16_SL1l1fT3SRbin_370_410=1,mask_run16_SL1l1fT3SRbin_410_450=1,mask_run16_SL1l1fT3SRbin_450_490=1,mask_run16_SL1l1fT3SRbin_490_530=1,mask_run16_SL1l2bT1SRbin_250_290=1,mask_run16_SL1l2bT1SRbin_290_330=1,mask_run16_SL1l2bT1SRbin_330_370=1,mask_run16_SL1l2bT1SRbin_370_410=1,mask_run16_SL1l2bT1SRbin_410_450=1,mask_run16_SL1l2bT1SRbin_450_490=1,mask_run16_SL1l2bT1SRbin_490_530=1,mask_run16_SL1l2bT2SRbin_250_290=1,mask_run16_SL1l2bT2SRbin_290_330=1,mask_run16_SL1l2bT2SRbin_330_370=1,mask_run16_SL1l2bT2SRbin_370_410=1,mask_run16_SL1l2bT2SRbin_410_450=1,mask_run16_SL1l2bT2SRbin_450_490=1,mask_run16_SL1l2bT2SRbin_490_530=1,mask_run16_SL1l2bT3SRbin_250_290=1,mask_run16_SL1l2bT3SRbin_290_330=1,mask_run16_SL1l2bT3SRbin_330_370=1,mask_run16_SL1l2bT3SRbin_370_410=1,mask_run16_SL1l2bT3SRbin_410_450=1,mask_run16_SL1l2bT3SRbin_450_490=1,mask_run16_SL1l2bT3SRbin_490_530=1,mask_run17_SL1l0fT1SRbin_250_290=1,mask_run17_SL1l0fT1SRbin_290_330=1,mask_run17_SL1l0fT1SRbin_330_370=1,mask_run17_SL1l0fT1SRbin_370_410=1,mask_run17_SL1l0fT1SRbin_410_450=1,mask_run17_SL1l0fT1SRbin_450_490=1,mask_run17_SL1l0fT1SRbin_490_530=1,mask_run17_SL1l0fT2SRbin_250_290=1,mask_run17_SL1l0fT2SRbin_290_330=1,mask_run17_SL1l0fT2SRbin_330_370=1,mask_run17_SL1l0fT2SRbin_370_410=1,mask_run17_SL1l0fT2SRbin_410_450=1,mask_run17_SL1l0fT2SRbin_450_490=1,mask_run17_SL1l0fT2SRbin_490_530=1,mask_run17_SL1l0fT3SRbin_250_290=1,mask_run17_SL1l0fT3SRbin_290_330=1,mask_run17_SL1l0fT3SRbin_330_370=1,mask_run17_SL1l0fT3SRbin_370_410=1,mask_run17_SL1l0fT3SRbin_410_450=1,mask_run17_SL1l0fT3SRbin_450_490=1,mask_run17_SL1l0fT3SRbin_490_530=1,mask_run17_SL1l1fT1SRbin_250_290=1,mask_run17_SL1l1fT1SRbin_290_330=1,mask_run17_SL1l1fT1SRbin_330_370=1,mask_run17_SL1l1fT1SRbin_370_410=1,mask_run17_SL1l1fT1SRbin_410_450=1,mask_run17_SL1l1fT1SRbin_450_490=1,mask_run17_SL1l1fT1SRbin_490_530=1,mask_run17_SL1l1fT2SRbin_250_290=1,mask_run17_SL1l1fT2SRbin_290_330=1,mask_run17_SL1l1fT2SRbin_330_370=1,mask_run17_SL1l1fT2SRbin_370_410=1,mask_run17_SL1l1fT2SRbin_410_450=1,mask_run17_SL1l1fT2SRbin_450_490=1,mask_run17_SL1l1fT2SRbin_490_530=1,mask_run17_SL1l1fT3SRbin_250_290=1,mask_run17_SL1l1fT3SRbin_290_330=1,mask_run17_SL1l1fT3SRbin_330_370=1,mask_run17_SL1l1fT3SRbin_370_410=1,mask_run17_SL1l1fT3SRbin_410_450=1,mask_run17_SL1l1fT3SRbin_450_490=1,mask_run17_SL1l1fT3SRbin_490_530=1,mask_run17_SL1l2bT1SRbin_250_290=1,mask_run17_SL1l2bT1SRbin_290_330=1,mask_run17_SL1l2bT1SRbin_330_370=1,mask_run17_SL1l2bT1SRbin_370_410=1,mask_run17_SL1l2bT1SRbin_410_450=1,mask_run17_SL1l2bT1SRbin_450_490=1,mask_run17_SL1l2bT1SRbin_490_530=1,mask_run17_SL1l2bT2SRbin_250_290=1,mask_run17_SL1l2bT2SRbin_290_330=1,mask_run17_SL1l2bT2SRbin_330_370=1,mask_run17_SL1l2bT2SRbin_370_410=1,mask_run17_SL1l2bT2SRbin_410_450=1,mask_run17_SL1l2bT2SRbin_450_490=1,mask_run17_SL1l2bT2SRbin_490_530=1,mask_run17_SL1l2bT3SRbin_250_290=1,mask_run17_SL1l2bT3SRbin_290_330=1,mask_run17_SL1l2bT3SRbin_330_370=1,mask_run17_SL1l2bT3SRbin_370_410=1,mask_run17_SL1l2bT3SRbin_410_450=1,mask_run17_SL1l2bT3SRbin_450_490=1,mask_run17_SL1l2bT3SRbin_490_530=1,mask_run18_SL1l0fT1SRbin_250_290=1,mask_run18_SL1l0fT1SRbin_290_330=1,mask_run18_SL1l0fT1SRbin_330_370=1,mask_run18_SL1l0fT1SRbin_370_410=1,mask_run18_SL1l0fT1SRbin_410_450=1,mask_run18_SL1l0fT1SRbin_450_490=1,mask_run18_SL1l0fT1SRbin_490_530=1,mask_run18_SL1l0fT2SRbin_250_290=1,mask_run18_SL1l0fT2SRbin_290_330=1,mask_run18_SL1l0fT2SRbin_330_370=1,mask_run18_SL1l0fT2SRbin_370_410=1,mask_run18_SL1l0fT2SRbin_410_450=1,mask_run18_SL1l0fT2SRbin_450_490=1,mask_run18_SL1l0fT2SRbin_490_530=1,mask_run18_SL1l0fT3SRbin_250_290=1,mask_run18_SL1l0fT3SRbin_290_330=1,mask_run18_SL1l0fT3SRbin_330_370=1,mask_run18_SL1l0fT3SRbin_370_410=1,mask_run18_SL1l0fT3SRbin_410_450=1,mask_run18_SL1l0fT3SRbin_450_490=1,mask_run18_SL1l0fT3SRbin_490_530=1,mask_run18_SL1l1fT1SRbin_250_290=1,mask_run18_SL1l1fT1SRbin_290_330=1,mask_run18_SL1l1fT1SRbin_330_370=1,mask_run18_SL1l1fT1SRbin_370_410=1,mask_run18_SL1l1fT1SRbin_410_450=1,mask_run18_SL1l1fT1SRbin_450_490=1,mask_run18_SL1l1fT1SRbin_490_530=1,mask_run18_SL1l1fT2SRbin_250_290=1,mask_run18_SL1l1fT2SRbin_290_330=1,mask_run18_SL1l1fT2SRbin_330_370=1,mask_run18_SL1l1fT2SRbin_370_410=1,mask_run18_SL1l1fT2SRbin_410_450=1,mask_run18_SL1l1fT2SRbin_450_490=1,mask_run18_SL1l1fT2SRbin_490_530=1,mask_run18_SL1l1fT3SRbin_250_290=1,mask_run18_SL1l1fT3SRbin_290_330=1,mask_run18_SL1l1fT3SRbin_330_370=1,mask_run18_SL1l1fT3SRbin_370_410=1,mask_run18_SL1l1fT3SRbin_410_450=1,mask_run18_SL1l1fT3SRbin_450_490=1,mask_run18_SL1l1fT3SRbin_490_530=1,mask_run18_SL1l2bT1SRbin_250_290=1,mask_run18_SL1l2bT1SRbin_290_330=1,mask_run18_SL1l2bT1SRbin_330_370=1,mask_run18_SL1l2bT1SRbin_370_410=1,mask_run18_SL1l2bT1SRbin_410_450=1,mask_run18_SL1l2bT1SRbin_450_490=1,mask_run18_SL1l2bT1SRbin_490_530=1,mask_run18_SL1l2bT2SRbin_250_290=1,mask_run18_SL1l2bT2SRbin_290_330=1,mask_run18_SL1l2bT2SRbin_330_370=1,mask_run18_SL1l2bT2SRbin_370_410=1,mask_run18_SL1l2bT2SRbin_410_450=1,mask_run18_SL1l2bT2SRbin_450_490=1,mask_run18_SL1l2bT2SRbin_490_530=1,mask_run18_SL1l2bT3SRbin_250_290=1,mask_run18_SL1l2bT3SRbin_290_330=1,mask_run18_SL1l2bT3SRbin_330_370=1,mask_run18_SL1l2bT3SRbin_370_410=1,mask_run18_SL1l2bT3SRbin_410_450=1,mask_run18_SL1l2bT3SRbin_450_490=1,mask_run18_SL1l2bT3SRbin_490_530=1,mask_run16_SL1l0fT1SRbin_250_290=1,mask_run16_SL1l0fT1SRbin_290_330=1,mask_run16_SL1l0fT1SRbin_330_370=1,mask_run16_SL1l0fT1SRbin_370_410=1,mask_run16_SL1l0fT1SRbin_410_450=1,mask_run16_SL1l0fT1SRbin_450_490=1,mask_run16_SL1l0fT1SRbin_490_530=1,mask_run16_SL1l0fT2SRbin_250_290=1,mask_run16_SL1l0fT2SRbin_290_330=1,mask_run16_SL1l0fT2SRbin_330_370=1,mask_run16_SL1l0fT2SRbin_370_410=1,mask_run16_SL1l0fT2SRbin_410_450=1,mask_run16_SL1l0fT2SRbin_450_490=1,mask_run16_SL1l0fT2SRbin_490_530=1,mask_run16_SL1l0fT3SRbin_250_290=1,mask_run16_SL1l0fT3SRbin_290_330=1,mask_run16_SL1l0fT3SRbin_330_370=1,mask_run16_SL1l0fT3SRbin_370_410=1,mask_run16_SL1l0fT3SRbin_410_450=1,mask_run16_SL1l0fT3SRbin_450_490=1,mask_run16_SL1l0fT3SRbin_490_530=1,mask_run16_SL1l1fT1SRbin_250_290=1,mask_run16_SL1l1fT1SRbin_290_330=1,mask_run16_SL1l1fT1SRbin_330_370=1,mask_run16_SL1l1fT1SRbin_370_410=1,mask_run16_SL1l1fT1SRbin_410_450=1,mask_run16_SL1l1fT1SRbin_450_490=1,mask_run16_SL1l1fT1SRbin_490_530=1,mask_run16_SL1l1fT2SRbin_250_290=1,mask_run16_SL1l1fT2SRbin_290_330=1,mask_run16_SL1l1fT2SRbin_330_370=1,mask_run16_SL1l1fT2SRbin_370_410=1,mask_run16_SL1l1fT2SRbin_410_450=1,mask_run16_SL1l1fT2SRbin_450_490=1,mask_run16_SL1l1fT2SRbin_490_530=1,mask_run16_SL1l1fT3SRbin_250_290=1,mask_run16_SL1l1fT3SRbin_290_330=1,mask_run16_SL1l1fT3SRbin_330_370=1,mask_run16_SL1l1fT3SRbin_370_410=1,mask_run16_SL1l1fT3SRbin_410_450=1,mask_run16_SL1l1fT3SRbin_450_490=1,mask_run16_SL1l1fT3SRbin_490_530=1,mask_run16_SL1l2bT1SRbin_250_290=1,mask_run16_SL1l2bT1SRbin_290_330=1,mask_run16_SL1l2bT1SRbin_330_370=1,mask_run16_SL1l2bT1SRbin_370_410=1,mask_run16_SL1l2bT1SRbin_410_450=1,mask_run16_SL1l2bT1SRbin_450_490=1,mask_run16_SL1l2bT1SRbin_490_530=1,mask_run16_SL1l2bT2SRbin_250_290=1,mask_run16_SL1l2bT2SRbin_290_330=1,mask_run16_SL1l2bT2SRbin_330_370=1,mask_run16_SL1l2bT2SRbin_370_410=1,mask_run16_SL1l2bT2SRbin_410_450=1,mask_run16_SL1l2bT2SRbin_450_490=1,mask_run16_SL1l2bT2SRbin_490_530=1,mask_run16_SL1l2bT3SRbin_250_290=1,mask_run16_SL1l2bT3SRbin_290_330=1,mask_run16_SL1l2bT3SRbin_330_370=1,mask_run16_SL1l2bT3SRbin_370_410=1,mask_run16_SL1l2bT3SRbin_410_450=1,mask_run16_SL1l2bT3SRbin_450_490=1,mask_run16_SL1l2bT3SRbin_490_530=1


mv -f fitDiagnostics_$name.root $dir

python $CMSSW_BASE/src/HiggsAnalysis/CombinedLimit/test/diffNuisances.py --vtol=0.0000001 -f text $dir/fitDiagnostics_$name.root | sed -e 's/!/ /g' -e 's/,/ /g' | tail -n +2 > $dir/pulls_$name.txt                        

sed -i -e 1,2d $dir/pulls_$name.txt

python pulls.py -b -f $dir/pulls_$name.txt -o $dir/pulls_$name

 
